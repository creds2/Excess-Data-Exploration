---
title: "Modeling spatial variation in energy use"
author: "Malcolm Morgan"
date: "11 June 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r, include=FALSE}
secure_path <- "E:/OneDrive - University of Leeds/CREDS Data/Tim Share"

```

## Input data

First load the data, some is England and Wales only so we will start with just there.

```{r, include=FALSE}
library(sf)
library(dplyr)
library(Hmisc)
bounds <- st_read("data-prepared/LSOA_generalised.gpkg")
elec <- read.csv("data-prepared/Electricty_2010-17.csv", stringsAsFactors = FALSE)
elec <- elec[!duplicated(elec$LSOA11),] 
gas <- read.csv("data-prepared/Gas_2010-17.csv", stringsAsFactors = FALSE)
mot <- read.csv(paste0(secure_path,"/From Tim/MOT Data RACv9.3/MOT Data RACv9.3 LSOAoutputs_2011.csv"), stringsAsFactors = FALSE)
age <- readRDS("data-prepared/age.Rds") # Not full UK
census <- readRDS("data-prepared/census_lsoa.Rds") # Not full UK
heating <- readRDS("data-prepared/central_heating.Rds") # Not full UK
EPC <- readRDS("data-prepared/EPC.Rds")
population <- readRDS("data-prepared/population.Rds") # Not full UK
density <- readRDS("data-prepared/populationDensity.Rds")
rooms <- readRDS("data-prepared/rooms.Rds")

dir.create("temp")
unzip("../Secure-Data/Excess/XSExpData1.zip", exdir = "temp")
tim <- read.csv("temp/XSExpData1.csv", stringsAsFactors = FALSE)
unlink("temp", recursive = T)

dir.create("temp")
unzip("../Secure-Data/Excess/Experian.zip", exdir = "temp")
experian <- read.csv("temp/UKDA-5738-csv/csv/2011-experian-data.csv", stringsAsFactors = FALSE)
unlink("temp", recursive = T)
names(experian) <- experian[4,]
experian <- experian[5:nrow(experian),]
experian <- experian[,c("GeographyValue","Median_(H) Household Income Value")]
names(experian) <- c("LSOA","median_household_income")

```

We will subets the data and join togther

```{r, include=FALSE}
bounds <- bounds[bounds$LSOA11 %in% census$CODE,]
elec <- elec[elec$LSOA11 %in% bounds$LSOA11, c("LSOA11","DomMet_11",
                                        "DomMet_17","MeanDomElec_11_kWh",
                                        "MeanDomElec_17_kWh",
                                        "TotDomElec_11_kWh","TotDomElec_17_kWh")]
gas <- gas[gas$LSOA11 %in% bounds$LSOA11, c("LSOA11","GasMet_11", "GasMet_17",
                                            "MeanDomGas_11_kWh","MeanDomGas_17_kWh",
                                            "TotDomGas_11_kWh", "TotDomGas_17_kWh")]
mot <- mot[mot$LSOA %in% bounds$LSOA11,]
names(mot) <- c("LSOA", "cars_total","cars_miles","pu5k","p5_12k","po12k","age_av","miles_av_u3",
                     "miles_av_o13","pcars_diesel","pmiles_diesel","vans_total","vans_miles",
                     "pmiles_car","pmiles_vans","cars_percap","miles_percap")
age <- age[age$lsoa %in% bounds$LSOA11, c("lsoa","BP_PRE_1900","BP_1900_1918","BP_1919_1929",
                                         "BP_1930_1939","BP_1945_1954","BP_1955_1964",
                                         "BP_1965_1972","BP_1973_1982","BP_1983_1992",
                                         "BP_1993_1999","BP_2000_2009","BP_2010_2015",
                                         "BP_UNKNOWN","ALL_PROPERTIES")]
census <- census[census$CODE %in% bounds$LSOA11,]
heating <- heating[heating$LSOA11 %in% bounds$LSOA11,]
EPC <- EPC[EPC$LSOA11 %in% bounds$LSOA11, c("LSOA11","Dwellings","Crr_EE","Ptn_EE")]
population <- population[population$LSOA11 %in% bounds$LSOA11,]
population$pop2011 <- as.numeric(population$pop2011)
population$pop2016 <- as.numeric(population$pop2016)
density$dense_2017 <- as.numeric(density$dense_2017)
density <- density[density$LSOA11 %in% bounds$LSOA11, ]



# Some values are more meaningful as percentages or averages
age$mean_house_age <- sapply(1:nrow(age), function(i){
  sub <- age[i,2:13]
  sub <- as.numeric(sub)
  res <- weighted.mean(x = c(1850,1909,1924,1934.5,1949.5,1959.5,1968.5,
                             1977.5,1987.5,1996,2004.5,2012.5) ,w = sub)
  return(res)
})

age$pP1900  <- round(age$BP_PRE_1900 / age$ALL_PROPERTIES * 100,2)
age$p1900_18 <- round(age$BP_1900_1918 / age$ALL_PROPERTIES * 100,2)
age$p1919_29 <- round(age$BP_1919_1929 / age$ALL_PROPERTIES * 100,2)
age$p1930_39 <- round(age$BP_1930_1939 / age$ALL_PROPERTIES * 100,2)
age$p1945_54 <- round(age$BP_1945_1954 / age$ALL_PROPERTIES * 100,2)
age$p1955_64 <- round(age$BP_1955_1964 / age$ALL_PROPERTIES * 100,2)
age$p1965_72 <- round(age$BP_1965_1972 / age$ALL_PROPERTIES * 100,2)
age$p1973_82 <- round(age$BP_1973_1982 / age$ALL_PROPERTIES * 100,2)
age$p1983_92 <- round(age$BP_1983_1992 / age$ALL_PROPERTIES * 100,2)
age$p1993_99 <- round(age$BP_1993_1999 / age$ALL_PROPERTIES * 100,2)
age$p2000_09 <- round(age$BP_2000_2009 / age$ALL_PROPERTIES * 100,2)
age$p2010_15 <- round(age$BP_2010_2015 / age$ALL_PROPERTIES * 100,2)
age$pUNKNOWN   <- round(age$BP_UNKNOWN / age$ALL_PROPERTIES * 100,2)

age <- age[,c("lsoa","mean_house_age","pP1900","p1900_18","p1919_29",
              "p1930_39","p1945_54","p1955_64","p1965_72","p1973_82",
              "p1983_92","p1993_99","p2000_09","p2010_15","pUNKNOWN")]

heating$pHeating_None <- round(heating$`No CH` / heating$All * 100,2)
heating$pHeating_Gas <- round(heating$Gas / heating$All * 100,2)
heating$pHeating_Electric <- round(heating$Electric / heating$All * 100,2)
heating$pHeating_Other <- round((heating$Oil + heating$`Solid fuel` + heating$Other)/ heating$All * 100,2)

heating <- heating[,c("LSOA11","pHeating_None","pHeating_Gas","pHeating_Electric","pHeating_Other")]

# Join Togther
all <- left_join(elec, gas, by = "LSOA11")
all <- left_join(all, mot, by = c("LSOA11" = "LSOA"))
all <- left_join(all, age, by = c("LSOA11" = "lsoa"))
all <- left_join(all, census, by = c("LSOA11" = "CODE"))
all <- left_join(all, heating, by = c("LSOA11" = "LSOA11"))
all <- left_join(all, EPC, by = c("LSOA11" = "LSOA11"))
all <- left_join(all, population, by = c("LSOA11" = "LSOA11"))
all <- left_join(all, density, by = c("LSOA11" = "LSOA11"))
all <- left_join(all, experian, by = c("LSOA11" = "LSOA"))
all <- left_join(all, rooms, by = c("LSOA11" = "geography.code"))
rm(age, census, density, elec, EPC, gas, heating, mot, population, experian, rooms)
```




## Examining Correlations

Let see which variaibles are correlated with energy use:

### Gas



```{r, include=FALSE}
all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_gas <- data.frame(R = correlations$r[,"MeanDomGas_11_kWh"], P = correlations$P[,"MeanDomGas_11_kWh"])
correlations_gas <- correlations_gas[order(correlations_gas$R),]
correlations_gas <- correlations_gas[correlations_gas$R > 0.5 | correlations_gas$R < -0.5,]
```

A table of the top correlations

```{r, echo=FALSE}
correlations_gas
```

The strongest correlation is with the number of rooms. This is unsurprising as bigger houses require more heating. The next strongest correlation is with the number of bedrooms, but as the number of bedrooms is closely realted to the number of rooms this is not very informative.


We could try a model of the top 5 variaibles
```{r}
# gas_lm0 = lm(MeanDomGas_11_kWh ~ mean_rooms + SocGrade_DE. + mean_bedrooms + SocGrade_AB. + median_household_income, data=all, na.action = na.exclude)
# summary(gas_lm0)
```

It would be more intresting to remove the affect of the number of rooms and see what is strongly correlated with the residuals.

```{r, echo=FALSE}
plot(all$MeanDomGas_11_kWh, all$mean_rooms,
     xlab = "Mean Domestic Gas consumption 2011 (kWh)",
     ylab = "Mean number of rooms per house")
```

Lets look at what best predicts the residuals after accounting for the number of rooms.

```{r, echo=FALSE}
gas_lm1 = lm(MeanDomGas_11_kWh ~ mean_rooms, data=all, na.action = na.exclude)
summary(gas_lm1)
plot(predict(gas_lm1),all$MeanDomGas_11_kWh,
     xlab="predicted",ylab="actual")
abline(a=0,b=1, col = "red")

all$gas_lm1_res = residuals(gas_lm1, na.action = na.exclude)

all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_gas_res <- data.frame(R = correlations$r[,"gas_lm1_res"], P = correlations$P[,"gas_lm1_res"])
correlations_gas_res <- correlations_gas_res[order(correlations_gas_res$R),]
correlations_gas_res <- correlations_gas_res[correlations_gas_res$R > 0.3 | correlations_gas_res$R < -0.3,]
correlations_gas_res
```

Some of these are more realted to car use (e.g. T2W_Car is the % of people travelling to work by car). Of the ones about houses SocialGrade_C2 is the strongest correlation.

```{r, echo=FALSE}
plot(all$MeanDomGas_11_kWh, all$SocGrade_C2.,
     xlab = "Mean Domestic Gas consumption 2011 (kWh)",
     ylab = "Social Grade C2")

plot(all$SocGrade_C2.,all$gas_lm1_res, 
     ylab = "Number of rooms residuals",
     xlab = "Social Grade C2")
```

So let try a new model with the two variaibles

```{r, echo=FALSE}
gas_lm2 = lm(MeanDomGas_11_kWh ~ mean_rooms + SocGrade_C2., data=all, na.action = na.exclude)
summary(gas_lm2)

plot(predict(gas_lm2),all$MeanDomGas_11_kWh,
     xlab="predicted",ylab="actual")
abline(a=0,b=1, col = "red")
```


We can repete the process

```{r, echo=FALSE}
all$gas_lm2_res = residuals(gas_lm2, na.action = na.exclude)

all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_gas_res <- data.frame(R = correlations$r[,"gas_lm2_res"], P = correlations$P[,"gas_lm2_res"])
correlations_gas_res <- correlations_gas_res[order(correlations_gas_res$R),]
correlations_gas_res <- correlations_gas_res[correlations_gas_res$R > 0.2 | correlations_gas_res$R < -0.2,]
correlations_gas_res
```

Hear some ofther appropiate variaibles such as the EPC rating (Crr_EE) and buidling age (mean_house_age) stand out as we the proortion of self empolyed people.

Let try a final model with all these added variaibles.

```{r, echo=FALSE}
gas_lm3 = lm(MeanDomGas_11_kWh ~ mean_rooms + SocGrade_C2. + Crr_EE + Self.Emp. + mean_house_age, data=all, na.action = na.exclude)
summary(gas_lm3)

plot(predict(gas_lm3),all$MeanDomGas_11_kWh,
     xlab="predicted",ylab="actual")
abline(a=0,b=1, col = "red")
```

So we have a model that can explain 68.9% of the variation in gas usage at LSOA level based on just 5 variables.


## Electricity

Lets Do the same for electricity

```{r}
all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_elec <- data.frame(R = correlations$r[,"MeanDomElec_11_kWh"], P = correlations$P[,"MeanDomElec_11_kWh"])
correlations_elec <- correlations_elec[order(correlations_elec$R),]
correlations_elec <- correlations_elec[correlations_elec$R > 0.5 | correlations_elec$R < -0.5,]
correlations_elec
```

Here we se the top factors are (excluding car related ones) Number of rooms, Self Employed, and % gas heating, detached houses , and % other heating.

```{r}
elec_lm0 = lm(MeanDomElec_11_kWh ~ mean_rooms + Self.Emp. + pHeating_Gas + Whole_House_Detached. + pHeating_Other, 
              data=all, na.action = na.exclude)
summary(elec_lm0)
```

What about the residuals?

```{r}
elec_lm1 = lm(MeanDomElec_11_kWh ~ mean_rooms, data=all, na.action = na.exclude)
summary(elec_lm1)
plot(predict(elec_lm1),all$MeanDomElec_11_kWh,
     xlab="predicted",ylab="actual")
abline(a=0,b=1, col = "red")

all$elec_lm1_res = residuals(elec_lm1, na.action = na.exclude)

all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_elec_res <- data.frame(R = correlations$r[,"elec_lm1_res"], P = correlations$P[,"elec_lm1_res"])
correlations_elec_res <- correlations_elec_res[order(correlations_elec_res$R),]
correlations_elec_res <- correlations_elec_res[correlations_elec_res$R > 0.3 | correlations_elec_res$R < -0.3,]
correlations_elec_res
```

The top residuals are % of differnt heating types, self empoyed and working from home.

```{r}
elec_lm2 = lm(MeanDomElec_11_kWh ~ mean_rooms + Self.Emp. + pHeating_Gas + pHeating_Electric + pHeating_Other + T2W_Home., 
              data=all, na.action = na.exclude)
summary(elec_lm2)
```

## Driving

Finally lets look at driving

```{r}
all_matrix <- all[,2:ncol(all)]
all_matrix <- data.matrix(all_matrix)

correlations <- rcorr(x = all_matrix, type="pearson")
correlations_cars <- data.frame(R = correlations$r[,"miles_percap"], P = correlations$P[,"miles_percap"])
correlations_cars <- correlations_cars[order(correlations_cars$R),]
correlations_cars <- correlations_cars[correlations_cars$R > 0.5 | correlations_cars$R < -0.5,]
correlations_cars
```

The top correlataions are quite broad, but inclicde household without cars, unemployment, and population density, car ownership per capita, number of rooms and bedrooms, and % travel to work by car.

```{r}
cars_lm0 = lm(miles_percap ~ cars_percap + T2W_Car. + NoCarsHH + Unemployed. + dense_2011, 
              data=all, na.action = na.exclude)
summary(cars_lm0)

plot(all$cars_percap, all$miles_percap,
     xlab="Cars per person",ylab="Miles per person",
     xlim = c(0,2), ylim = c(0,20000))


plot(predict(cars_lm0),all$miles_percap,
     xlab="predicted",ylab="actual", xlim = c(0,20000), ylim = c(0,20000))
abline(a=0,b=1, col = "red")
```

There is a very strong correlation between cars per person and miles driven per person, suggesting that a car owned is a car driven. It is perhaps unserprising that people do not own a lot of cars they don't need, conversly it is impossible to drive a non-esitant car. So lets remove the car ownerhip to get a learer idea of what else matters.

```{r}
cars_lm1 = lm(miles_percap ~  T2W_Car. + NoCarsHH + Unemployed. + dense_2011, 
              data=all, na.action = na.exclude)
summary(cars_lm1)

plot(predict(cars_lm1),all$miles_percap,
     xlab="predicted",ylab="actual", xlim = c(0,20000), ylim = c(0,20000))
abline(a=0,b=1, col = "red")
```

Still a reasonalby good fit (R^2 of 0.79), but there is some clear non-linerality to this relationship.

```{r}
pairs(all[all$miles_percap < 30000,
          c("miles_percap", "T2W_Car.", "NoCarsHH" , "Unemployed.", "dense_2011")])
```

It seems that density has a non-linear effect on driving.

```{r}
plot(all$dense_2011, all$miles_percap,
     xlab="People per km ^2",ylab="Miles per person",
     ylim = c(0, 20000))
# fit non-linear model
cars_lm2a = lm(miles_percap ~  dense_2011, data=all, na.action = na.exclude)
cars_lm2b = nls(miles_percap ~ a * exp(b * dense_2011), data = all, start = list(a = 8000, b = -7e-5),
                na.action = na.exclude)
cars_lm2c = lm(miles_percap ~ exp(-7.25e-5 * dense_2011), data=all, na.action = na.exclude)
summary(cars_lm2a)
summary(cars_lm2c)
```

If we put that back into the original model.

```{r}
cars_lm3 = lm(miles_percap ~  T2W_Car. + NoCarsHH + Unemployed. +                  exp(-7.25e-5 * dense_2011), 
              data=all, na.action = na.exclude)
summary(cars_lm3)

plot(predict(cars_lm3),all$miles_percap,
     xlab="predicted",ylab="actual", xlim = c(0,20000), ylim = c(0,20000))
abline(a=0,b=1, col = "red")
```

It didn't help very much :(

So try a polynomial on density and No car households

```{r}
cars_lm4 = lm(miles_percap ~  T2W_Car. + poly(NoCarsHH, 2) + Unemployed. + poly(dense_2011, 2), 
              data=all, na.action = na.exclude)
summary(cars_lm4)

plot(predict(cars_lm4),all$miles_percap,
     xlab="predicted",ylab="actual", xlim = c(0,20000), ylim = c(0,20000))
abline(a=0,b=1, col = "red")
```

Mutch better but still seeing an S-bend to the data?

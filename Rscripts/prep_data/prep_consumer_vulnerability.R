# Prep consumer vulnerability
library(dplyr)

cv <- read.csv("data-input/consumer vulnerability/consumervulnerabiltyclusters.csv")
cv_lookup <- data.frame(cluster = c("A","B","C","D","E","F"), 
                        vulnerabilty = c("Prosperous Professionals","Well Established",
                                         "Students and Young Professionals","On a Budget", 
                                         "Vulnerable Communities","Vulnerable Pensioners"))
cv <- left_join(cv, cv_lookup, by = "cluster")


lookup <- read.csv("data-input/OA Lookup/oa_lookup_dec_2011.csv", stringsAsFactors = F)
lookup <- lookup[,1:2]
names(lookup) <- c("OA11","LSOA11")


cv <- left_join(cv, lookup, by = c("output_area" = "OA11"))
summary(is.na(cv$LSOA11))
cv <- cv[!is.na(cv$LSOA11),]
cv <- cv[,c("LSOA11","vulnerabilty" )]

cv$vulnerabilty <- as.character(cv$vulnerabilty)
cv_lsoa <- cv %>%
  group_by(LSOA11) %>%
  summarise(top_vulnerabilty = names(which.max(table(vulnerabilty))),
            second_vulnerabilty = names(sort(table(vulnerabilty), decreasing = T))[2],
            numb_vulnerabilty_clust = length(unique(vulnerabilty))
  )

saveRDS(cv_lsoa,"data-prepared/consumervulnerabilty.Rds")
